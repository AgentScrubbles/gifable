<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />
    <style>
      #results {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
      }
      figure {
        position: relative;
        display: inline-block;
        margin: 0.5em;
        text-align: center;
      }
      body {
        grid-template-columns: 1fr min(60em, 90%) 1fr;
      }
      .copy-button {
        position: absolute;
        font-size: 0.8em;
        top: 0.2em;
        right: 0.5em;
        padding: 0;
        border-radius: 100%;
        width: 2em;
        height: 2em;
      }
      figure > a > img {
        border: 1px solid transparent;
        width: 100%;
      }
      figure > a:hover > img {
        border-color: var(--accent);
      }
    </style>
    <title>Gifme</title>
  </head>
  <body>
    <header>
      <h1>Gifme</h1>
      <nav>
        <a class="current" href="/">Search</a>
        <a href="/add">Add</a>
      </nav>
    </header>

    <main id="main">
      <em><center>Loading...</center></em>
    </main>

    <script type="module" defer>
      import { render } from 'https://esm.sh/preact';
      import { html } from 'https://esm.sh/htm/preact';
      import { useState, useEffect } from 'https://esm.sh/preact/hooks';

      const params = new URLSearchParams(window.location.search);
      const q = params.get('q');

      function App(props) {
        const [assets, setAssets] = useState([]);
        const [search, setSearch] = useState(q || '');

        useEffect(async () => {
          let params = '';
          if (search) {
            params = new URLSearchParams({ search });
          }
          const resp = await fetch('/api/assets?' + params);
          setAssets(await resp.json());
          window.history.pushState(null, '', '/?' + params);
        }, [search]);

        return html`<div>
          <${Search} setSearch=${setSearch} search=${search} />
          <${Results} assets=${assets} />
        </div>`;
      }

      function Search(props) {
        return html`<search
          ><input
            type="search"
            value=${props.search}
            placeholder="Search"
            onInput=${debounce(
              (event) => props.setSearch(event.target.value),
              500
            )}
        /></search>`;
      }

      function Results(props) {
        return html`<div id="results">${props.assets.map(Asset)}</div>`;
      }

      function Asset(props) {
        return html`<figure>
          <a href="/view?id=${props.id}">
            <img src="${props.url}" alt=${props.comment} />
            <${CopyButton} url="${props.url}" />
          </a>
          <figcaption>${props.comment}</figcaption>
        </figure>`;
      }

      function CopyButton(props) {
        return html`<button
          classList="copy-button"
          title="Copy url"
          onClick=${(event) => {
            event.preventDefault();
            navigator.clipboard.writeText(props.url);
          }}
        >
          ðŸ”—
        </button>`;
      }

      function debounce(callback, wait) {
        let timeoutId = null;
        return (...args) => {
          window.clearTimeout(timeoutId);
          timeoutId = window.setTimeout(() => {
            callback.apply(null, args);
          }, wait);
        };
      }

      render(html`<${App} />`, document.getElementById('main'));
    </script>
  </body>
</html>
