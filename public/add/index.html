<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="/style.css" />
    <title>ðŸ¦© Gifme</title>
  </head>
  <body>
    <header>
      <h1>Gifme</h1>
      <nav>
        <a href="/">Search</a>
        <a class="current" href="/add">Add</a>
      </nav>
    </header>

    <main>
      <form id="add-form" name="add">
        <fieldset id="add-fieldset">
          <legend><h3>Add a file</h3></legend>
          <label for="url">URL</label>
          <input id="url" name="url" type="text" required />
          <label for="name">File name</label>
          <input
            id="filename"
            name="filename"
            type="text"
            pattern="^[a-z0-9]+\.(gif|jpg|png)$"
            required
            placeholder="example.gif"
          />
          <label for="comment">Comment</label>
          <textarea id="comment" name="comment"></textarea>
          <div id="message"></div>
          <button type="reset">Reset</button>
          <button type="submit">Save</button>
        </fieldset>
      </form>
    </main>

    <script type="module">
      const form = document.getElementById('add-form');
      const fieldset = document.getElementById('add-fieldset');
      const message = document.getElementById('message');

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = serializeForm(event.target);
        setLoading(true);

        try {
          const data = await request('POST', '/api/upload', formData);
          formData.url = data.url;
        } catch (error) {
          setMessage(error.message);
          setLoading(false);
          return;
        }

        try {
          const response = await request('POST', '/api/assets', formData);
          window.location = '/view?id=' + response.id;
        } catch (error) {
          setMessage(error.message);
          setLoading(false);
        }
      });

      const inputs = document.querySelectorAll('input, select, textarea');

      inputs.forEach((input) => {
        input.addEventListener('invalid', (event) => {
          input.classList.add('error');
        });
      });

      form.addEventListener('reset', () => {
        inputs.forEach((input) => {
          input.classList.remove('error');
        });
        setMessage('');
      });

      function request(method, url, data) {
        return fetch(url, {
          method,
          body: JSON.stringify(data),
          headers: {
            'Content-type': 'application/json; charset=UTF-8',
          },
        }).then(async (response) => {
          const json = await response.json();
          if (response.ok) {
            return json;
          }
          throw json;
        });
      }

      function setLoading(loading) {
        if (!loading) {
          fieldset.disabled = false;
          fieldset.querySelector('button[type="submit"]').textContent = 'Save';
          return;
        }
        fieldset.disabled = true;
        fieldset.querySelector('button[type="submit"]').textContent =
          'Saving...';
      }

      function setMessage(str) {
        message.lastChild?.remove();

        if (!str) return;
        const p = document.createElement('p');
        p.classList.add('notice');
        p.textContent = str;
        message.appendChild(p);
      }

      function serializeForm(form) {
        const obj = {};
        const formData = new FormData(form);
        for (const key of formData.keys()) {
          obj[key] = formData.get(key);
        }
        return obj;
      }
    </script>
  </body>
</html>
